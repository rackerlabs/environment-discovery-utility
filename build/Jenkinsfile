#!/usr/bin/env groovy
pipeline {
    agent any
    parameters {
        string(name: 'branch', defaultValue: 'develop', description: '')
        string(name: 'slackChannel', defaultValue: 'edu-cicd', description: '')
        string(name: 'staticLabIpAddress', defaultValue: '172.29.20.13', description: '')
        string(name: 'jmlLabIpAddress', defaultValue: '172.29.12.224', description: '')
        string(name: 'multiDomainLabIpAddress', defaultValue: '172.29.23.157', description: '')
    }
    stages {
        stage('Checkout') {
            steps {
                slackSend channel: "${slackChannel}", message: "${env.JOB_NAME} - [${branch}] - #${env.BUILD_NUMBER} Started (<${env.BUILD_URL}|Open>)."

                checkout (
                    changelog: true,
                    poll: true,
                    scm: [ 
                        $class: 'GitSCM', 
                        branches: [[name: "master"]], 
                        doGenerateSubmoduleConfigurations: false, 
                        extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'build\\tools']] + [[$class: 'CleanCheckout']],
                        submoduleCfg: [], 
                        userRemoteConfigs: [[credentialsId: 'james.blake', url: 'git@github.rackspace.com:MicrosoftEng/build-tools.git']]
                    ]
                )
            }
        }
        stage('Sign') {
            steps {
                slackSend channel: "${slackChannel}", message: "${env.JOB_NAME} - [${branch}] - #${env.BUILD_NUMBER} Signing script files."

                withCredentials([
                    usernamePassword(credentialsId: '1e14ecee-ea70-4dc9-b1a6-7946fab6c8bb', passwordVariable: 'password', usernameVariable: 'username'),
                    file(credentialsId: '9dc4abad-d55c-4621-a70c-d73b1803d6fe', variable: 'certificate')
                ]) {
                    bat """powershell.exe -ExecutionPolicy Unrestricted -Command .\\build\\Sign-ScriptFiles.ps1 -Password '%password%' -Username '%username%' -certificate %certificate%"""
                }
            }
        }
        stage('Zip') {
            steps {
                slackSend channel: "${slackChannel}", message: "${env.JOB_NAME} - [${branch}] - #${env.BUILD_NUMBER} Zipping files."

                bat 'powershell.exe -ExecutionPolicy Unrestricted -Command .\\build\\New-ZipFile.ps1 -BuildNumber %BUILD_NUMBER%'
            }
        }
        stage('Run Remote Tests') {
            steps {
                parallel (
                    "Single domain / Exchange 2010 / PowerShell v2 lab" : {
                        slackSend channel: "${slackChannel}", message: "${env.JOB_NAME} - [${branch}] - #${env.BUILD_NUMBER} Running single domain / Exchange 2010 / PowerShell v2 lab tests."

                        withCredentials([
                            usernamePassword(credentialsId: '03bbc260-f717-48f0-b16a-c97ba14e6d85', passwordVariable: 'password', usernameVariable: 'username')
                        ]) {
                            bat 'powershell.exe -ExecutionPolicy Unrestricted -Command .\\build\\Invoke-RemoteTesting.ps1 -BuildNumber %BUILD_NUMBER% -LabIpAddress %staticLabIpAddress% -Password %password% -Username %username% -EduZipFile .\\build\\edu.v%BUILD_NUMBER%.zip'
                        }

                        slackSend channel: "${slackChannel}", color: 'good',  message: "${env.JOB_NAME} - [${branch}] - #${env.BUILD_NUMBER} Single domain / Exchange 2010 / PowerShell v2 lab tests successful."
                    },
                    "Single domain / Exchange 2013/2016 / PowerShell v4 / JML lab" : {
                        slackSend channel: "${slackChannel}", message: "${env.JOB_NAME} - [${branch}] - #${env.BUILD_NUMBER} Running single domain / Exchange 2013/2016 / PowerShell v4 / JML lab tests."

                        withCredentials([
                            usernamePassword(credentialsId: '5de43889-57c2-41ad-a17b-06cf6eb92ffd', passwordVariable: 'password', usernameVariable: 'username')
                        ]) {
                            bat 'powershell.exe -ExecutionPolicy Unrestricted -Command .\\build\\Invoke-RemoteTesting.ps1 -BuildNumber %BUILD_NUMBER% -LabIpAddress %jmlLabIpAddress% -Password %password% -Username %username% -EduZipFile .\\build\\edu.v%BUILD_NUMBER%.zip'
                        }

                        slackSend channel: "${slackChannel}", color: 'good',  message: "${env.JOB_NAME} - [${branch}] - #${env.BUILD_NUMBER} Single domain / Exchange 2013/2016 / PowerShell v4 / JML lab tests successful." 
                    },
                    "Multi-domain / Exchange 2013 / PowerShell v4 lab" : {
                        slackSend channel: "${slackChannel}", message: "${env.JOB_NAME} - [${branch}] - #${env.BUILD_NUMBER} Running multi-domain / Exchange 2013 / PowerShell v4 lab tests."

                        withCredentials([
                            usernamePassword(credentialsId: 'f344bfd0-63dd-4426-92dd-4e9016e0c526', passwordVariable: 'password', usernameVariable: 'username')
                        ]) {
                            bat 'powershell.exe -ExecutionPolicy Unrestricted -Command .\\build\\Invoke-RemoteTesting.ps1 -BuildNumber %BUILD_NUMBER% -LabIpAddress %multiDomainLabIpAddress% -Password %password% -Username %username% -EduZipFile .\\build\\edu.v%BUILD_NUMBER%.zip'
                        }

                        slackSend channel: "${slackChannel}", color: 'good',  message: "${env.JOB_NAME} - [${branch}] - #${env.BUILD_NUMBER} Multi-domain / Exchange 2013 / PowerShell v4 lab tests successful." 
                    },
                )				
            }
        }
    }
    post {
        success {		
            archiveArtifacts artifacts: "build/edu.v${env.BUILD_NUMBER}.zip"
            archiveArtifacts artifacts: "build/${env.staticLabIpAddress}/edu-${env.staticLabIpAddress}.zip"
            archiveArtifacts artifacts: "build/${env.jmlLabIpAddress}/edu-${env.jmlLabIpAddress}.zip"
            archiveArtifacts artifacts: "build/${env.multiDomainLabIpAddress}/edu-${env.multiDomainLabIpAddress}.zip"

            slackSend channel: "${slackChannel}", color: 'good', message: "${env.JOB_NAME} - [${branch}] - #${env.BUILD_NUMBER} All tests were successful (<${env.BUILD_URL}|Open>)."
            slackSend channel: "${slackChannel}", color: 'good', message: "${env.JOB_NAME} - [${branch}] - #${env.BUILD_NUMBER} Distributable: (<https://jenkins.mseng.mlsrvr.com/view/EDU/job/edu_ci/${env.BUILD_NUMBER}/artifact/build/edu.v${env.BUILD_NUMBER}.zip|Download Zip>)."
            slackSend channel: "${slackChannel}", color: 'good', message: "${env.JOB_NAME} - [${branch}] - #${env.BUILD_NUMBER} Single domain / Exchange 2010 / PowerShell v2 results: (<https://jenkins.mseng.mlsrvr.com/view/EDU/job/edu_ci/${env.BUILD_NUMBER}/artifact/build/${env.staticLabIpAddress}/edu-${env.staticLabIpAddress}.zip|Download Zip>)."
            slackSend channel: "${slackChannel}", color: 'good', message: "${env.JOB_NAME} - [${branch}] - #${env.BUILD_NUMBER} Single domain / Exchange 2013/2016 / PowerShell v4 / JML results: (<https://jenkins.mseng.mlsrvr.com/view/EDU/job/edu_ci/${env.BUILD_NUMBER}/artifact/build/${env.jmlLabIpAddress}/edu-${env.jmlLabIpAddress}.zip|Download Zip>)."
            slackSend channel: "${slackChannel}", color: 'good', message: "${env.JOB_NAME} - [${branch}] - #${env.BUILD_NUMBER} Multi-domain / Exchange 2013 / PowerShell v4 results: (<https://jenkins.mseng.mlsrvr.com/view/EDU/job/edu_ci/${env.BUILD_NUMBER}/artifact/build/${env.multiDomainLabIpAddress}/edu-${env.multiDomainLabIpAddress}.zip|Download Zip>)."
        }
        failure {
            slackSend channel: "${slackChannel}", color: 'danger', message: "${env.JOB_NAME} - [${branch}] - #${env.BUILD_NUMBER} Failure (<${env.BUILD_URL}|Open>)."
        }
    }
}
